// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  ADMIN
  PRIEST
  ORGANIZER
  MEMBER
  VISITOR
}

enum EventStatus {
  DRAFT
  PUBLISHED
  CANCELLED
  COMPLETED
}

enum ParticipantLevel {
  NOVICE    // Novato
  SERVANT   // Servo
  LEADER    // Líder
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum PriestRegistrationStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
  REQUIRES_DOCUMENTATION
}

enum DocumentType {
  ORDINATION_CERTIFICATE
  IDENTITY_DOCUMENT
  RESIDENCE_PROOF
  RECOMMENDATION_LETTER
  OTHER
}

enum DocumentStatus {
  PENDING
  APPROVED
  REJECTED
  REQUIRES_REPLACEMENT
}

// User and Authentication
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  role      UserRole @default(VISITOR)
  isActive  Boolean  @default(true)
  emailVerified Boolean @default(false)
  emailVerifiedAt DateTime?
  lastLoginAt DateTime?
  
  // Profile
  profile   UserProfile?
  
  // Relations
  parishes  ParishPriest[]
  events    Event[]
  registrations EventRegistration[]
  eventComments EventComment[]
  appointments  Appointment[]
  ministryMembers MinistryMember[]
  emailVerificationTokens EmailVerificationToken[]
  formSubmissions EventFormSubmission[]
  waitingLists  EventWaitingList[]
  notificationLogs EventNotificationLog[]
  
  // Priest Registration
  priestRegistration PriestRegistration?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([role])
  @@index([isActive])
  @@index([email])
  @@map("users")
}

model UserProfile {
  id          String  @id @default(cuid())
  userId      String  @unique
  user        User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  firstName   String
  lastName    String
  phone       String?
  avatar      String?
  bio         String? @db.Text
  
  // Location
  stateId     String?
  state       State?  @relation(fields: [stateId], references: [id])
  cityId      String?
  city        City?   @relation(fields: [cityId], references: [id])
  neighborhoodId String?
  neighborhood   Neighborhood? @relation(fields: [neighborhoodId], references: [id])
  
  // Participant data
  level       ParticipantLevel @default(NOVICE)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("user_profiles")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  
  createdAt DateTime @default(now())
  
  @@index([email])
  @@index([token])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([token])
  @@map("email_verification_tokens")
}

// Location Models
model State {
  id          String @id @default(cuid())
  name        String
  code        String @unique // SP, RJ, etc.
  
  cities      City[]
  parishes    Parish[]
  profiles    UserProfile[]
  
  @@map("states")
}

model City {
  id          String @id @default(cuid())
  name        String
  stateId     String
  state       State  @relation(fields: [stateId], references: [id])
  
  neighborhoods Neighborhood[]
  parishes    Parish[]
  profiles    UserProfile[]
  events      Event[]
  
  @@map("cities")
}

model Neighborhood {
  id          String @id @default(cuid())
  name        String
  cityId      String
  city        City   @relation(fields: [cityId], references: [id])
  
  parishes    Parish[]
  profiles    UserProfile[]
  
  @@map("neighborhoods")
}

// Parish Models
model Diocese {
  id        String   @id @default(cuid())
  name      String
  
  parishes  Parish[]
  priestRegistrations     PriestRegistration[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("dioceses")
}

model Parish {
  id          String @id @default(cuid())
  name        String
  address     String
  description String? @db.Text
  phone       String?
  email       String?
  website     String?
  
  // Location
  stateId     String
  state       State  @relation(fields: [stateId], references: [id])
  cityId      String
  city        City   @relation(fields: [cityId], references: [id])
  neighborhoodId String?
  neighborhood   Neighborhood? @relation(fields: [neighborhoodId], references: [id])
  
  // Geographic coordinates
  latitude    Float?
  longitude   Float?
  
  // Diocese
  dioceseId   String
  diocese     Diocese @relation(fields: [dioceseId], references: [id])
  
  // Relations
  priests     ParishPriest[]
  contacts    ParishContact[]
  masses      Mass[]
  events      Event[]
  ministries  Ministry[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([stateId])
  @@index([cityId])
  @@index([neighborhoodId])
  @@index([dioceseId])
  @@index([name])
  @@map("parishes")
}

model ParishPriest {
  id        String  @id @default(cuid())
  parishId  String
  parish    Parish  @relation(fields: [parishId], references: [id], onDelete: Cascade)
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  isMain    Boolean @default(false) // Pároco principal
  
  createdAt DateTime @default(now())
  
  @@unique([parishId, userId])
  @@map("parish_priests")
}

model ParishContact {
  id        String @id @default(cuid())
  parishId  String
  parish    Parish @relation(fields: [parishId], references: [id], onDelete: Cascade)
  
  type      String // facebook, instagram, whatsapp, etc.
  value     String
  
  @@map("parish_contacts")
}

model Mass {
  id          String @id @default(cuid())
  parishId    String
  parish      Parish @relation(fields: [parishId], references: [id], onDelete: Cascade)
  
  dayOfWeek   Int    // 0 = Sunday, 1 = Monday, etc.
  time        String // "08:00", "19:30", etc.
  type        String @default("normal") // normal, children, wedding, etc.
  language    String @default("pt") // pt, en, es, etc.
  description String?
  
  isActive    Boolean @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("masses")
}

// Priest Registration Models
model PriestRegistration {
  id                  String                   @id @default(cuid())
  userId              String?                  @unique
  user                User?                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Personal Information
  firstName           String
  lastName            String
  email               String                   @unique
  phone               String
  birthDate           DateTime
  cpf                 String                   @unique
  bio                 String?                  @db.Text
  
  // Ecclesiastical Information
  ordinationNumber    String                   @unique
  ordinationDate      DateTime
  ordinationDioceseId String
  ordinationDiocese   Diocese                  @relation(fields: [ordinationDioceseId], references: [id])
  seminary            String?
  specializations     Json?                    // Array of specializations
  languages           Json?                    // Array of languages
  
  // Registration Status
  status              PriestRegistrationStatus @default(PENDING)
  statusUpdatedAt     DateTime                 @default(now())
  statusUpdatedBy     String?                  // Admin user ID
  
  // Review and Comments
  reviewComments      String?                  @db.Text
  internalNotes       String?                  @db.Text
  
  // Documents
  documents           PriestDocument[]
  
  // Approval History
  approvalHistory     PriestApprovalHistory[]
  
  // Email verification
  emailVerified       Boolean                  @default(false)
  emailVerificationToken String?               @unique
  emailVerificationSentAt DateTime?
  
  createdAt           DateTime                 @default(now())
  updatedAt           DateTime                 @updatedAt
  
  @@index([status])
  @@index([email])
  @@index([cpf])
  @@index([ordinationNumber])
  @@map("priest_registrations")
}

model PriestDocument {
  id                    String                 @id @default(cuid())
  registrationId        String
  registration          PriestRegistration     @relation(fields: [registrationId], references: [id], onDelete: Cascade)
  
  type                  DocumentType
  fileName              String
  originalFileName      String
  filePath              String
  fileSize              Int
  mimeType              String
  
  status                DocumentStatus         @default(PENDING)
  statusUpdatedAt       DateTime               @default(now())
  statusUpdatedBy       String?                // Admin user ID
  
  reviewComments        String?                @db.Text
  
  uploadedAt            DateTime               @default(now())
  
  @@index([registrationId])
  @@index([type])
  @@index([status])
  @@map("priest_documents")
}

model PriestApprovalHistory {
  id                String               @id @default(cuid())
  registrationId    String
  registration      PriestRegistration   @relation(fields: [registrationId], references: [id], onDelete: Cascade)
  
  fromStatus        PriestRegistrationStatus
  toStatus          PriestRegistrationStatus
  comments          String?              @db.Text
  
  // Admin who made the change
  adminId           String?
  adminEmail        String?
  
  createdAt         DateTime             @default(now())
  
  @@index([registrationId])
  @@map("priest_approval_history")
}

// Event Models
model Event {
  id              String      @id @default(cuid())
  title           String
  slug            String      @unique
  description     String      @db.Text
  content         String?     @db.LongText
  
  // Date and Location
  startDate       DateTime
  endDate         DateTime?
  timezone        String      @default("America/Sao_Paulo")
  location        String
  address         String?
  coordinates     String?     // "lat,lng" format
  isOnline        Boolean     @default(false)
  onlineUrl       String?
  
  // Event Configuration
  maxParticipants Int?
  minParticipants Int?        @default(1)
  price           Decimal?    @db.Decimal(10,2)
  currency        String      @default("BRL")
  
  // Categories and Tags
  category        String
  tags            Json?       // Array of tags
  targetAudience  Json?       // Array of target groups
  ageMin          Int?
  ageMax          Int?
  
  // Registration Configuration
  registrationRequired Boolean @default(true)
  registrationStart   DateTime?
  registrationEnd     DateTime?
  requiresApproval    Boolean  @default(false)
  customForm          Json?    // Dynamic form configuration
  
  // Event Status and Visibility
  status          EventStatus @default(DRAFT)
  isPublic        Boolean     @default(true)
  isFeatured      Boolean     @default(false)
  
  // Media
  coverImage      String?
  gallery         Json?       // Array of image URLs
  attachments     Json?       // Array of file URLs and names
  
  // Relations
  organizerId     String
  organizer       User        @relation(fields: [organizerId], references: [id])
  parishId        String?
  parish          Parish?     @relation(fields: [parishId], references: [id])
  cityId          String?
  city            City?       @relation(fields: [cityId], references: [id])
  
  registrations   EventRegistration[]
  products        EventProduct[]
  comments        EventComment[]
  form            EventForm?
  waitingList     EventWaitingList[]
  notificationTemplates EventNotificationTemplate[]
  
  // SEO and Metadata
  metaTitle       String?
  metaDescription String?
  
  // Tracking
  viewCount       Int         @default(0)
  shareCount      Int         @default(0)
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  publishedAt     DateTime?
  
  @@index([status])
  @@index([category])
  @@index([startDate])
  @@index([organizerId])
  @@index([parishId])
  @@map("events")
}

model EventRegistration {
  id          String @id @default(cuid())
  eventId     String
  event       Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId      String
  user        User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  status      String @default("confirmed") // confirmed, waiting, cancelled
  data        Json?  // Additional form data
  
  formSubmission EventFormSubmission?
  
  createdAt   DateTime @default(now())
  
  @@unique([eventId, userId])
  @@map("event_registrations")
}

model EventComment {
  id        String   @id @default(cuid())
  eventId   String
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  content   String   @db.Text
  isPublic  Boolean  @default(true)
  
  // Moderation
  isApproved Boolean @default(true)
  moderatedBy String?
  moderatedAt DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([eventId])
  @@index([userId])
  @@map("event_comments")
}

// Mini Bar Models
model EventProduct {
  id          String @id @default(cuid())
  eventId     String
  event       Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  name        String
  description String?
  price       Decimal @db.Decimal(10,2)
  stock       Int     @default(0)
  category    String
  image       String?
  
  orders      ProductOrder[]
  
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("event_products")
}

model ProductOrder {
  id          String       @id @default(cuid())
  productId   String
  product     EventProduct @relation(fields: [productId], references: [id])
  userId      String
  
  quantity    Int
  unitPrice   Decimal      @db.Decimal(10,2)
  totalPrice  Decimal      @db.Decimal(10,2)
  
  createdAt   DateTime     @default(now())
  
  @@map("product_orders")
}

// Ministry Models
model Ministry {
  id          String @id @default(cuid())
  name        String
  description String? @db.Text
  
  parishId    String
  parish      Parish @relation(fields: [parishId], references: [id], onDelete: Cascade)
  
  members     MinistryMember[]
  schedules   MinistrySchedule[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("ministries")
}

model MinistryMember {
  id          String   @id @default(cuid())
  ministryId  String
  ministry    Ministry @relation(fields: [ministryId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  role        String   @default("member") // leader, assistant, member
  isActive    Boolean  @default(true)
  
  schedules   MinistrySchedule[]
  
  joinedAt    DateTime @default(now())
  
  @@unique([ministryId, userId])
  @@map("ministry_members")
}

model MinistrySchedule {
  id          String         @id @default(cuid())
  ministryId  String
  ministry    Ministry       @relation(fields: [ministryId], references: [id], onDelete: Cascade)
  memberId    String
  member      MinistryMember @relation(fields: [memberId], references: [id], onDelete: Cascade)
  
  date        DateTime
  time        String
  description String?
  type        String // mass, event, meeting, etc.
  
  confirmed   Boolean @default(false)
  
  createdAt   DateTime @default(now())
  
  @@map("ministry_schedules")
}

// Appointment Models
model Appointment {
  id          String            @id @default(cuid())
  userId      String
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type        String            // confession, counseling, meeting
  date        DateTime
  time        String
  duration    Int               @default(30) // minutes
  
  description String?           @db.Text
  notes       String?           @db.Text
  
  status      AppointmentStatus @default(PENDING)
  
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  
  @@map("appointments")
}

// Event Registration Form Models
model EventForm {
  id          String @id @default(cuid())
  eventId     String @unique
  event       Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  title       String @default("Formulário de Inscrição")
  description String? @db.Text
  
  // Form configuration
  isActive    Boolean @default(true)
  allowMultipleSubmissions Boolean @default(false)
  requiresApproval Boolean @default(false)
  
  // Timing
  opensAt     DateTime?
  closesAt    DateTime?
  
  fields      EventFormField[]
  submissions EventFormSubmission[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("event_forms")
}

model EventFormField {
  id          String @id @default(cuid())
  formId      String
  form        EventForm @relation(fields: [formId], references: [id], onDelete: Cascade)
  
  // Field definition
  type        EventFormFieldType
  name        String // internal name (slug)
  label       String // display label
  placeholder String?
  helpText    String?
  
  // Validation
  isRequired  Boolean @default(false)
  minLength   Int?
  maxLength   Int?
  pattern     String? // regex pattern
  
  // Options for select/radio/checkbox
  options     Json? // array of {value, label}
  
  // Conditional logic
  showIfField String? // show this field if another field has specific value
  showIfValue String? // the value that triggers showing this field
  
  // Order and grouping
  order       Int     @default(0)
  group       String? // group fields together
  
  responses   EventFormResponse[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([formId])
  @@map("event_form_fields")
}

model EventFormSubmission {
  id            String @id @default(cuid())
  formId        String
  form          EventForm @relation(fields: [formId], references: [id], onDelete: Cascade)
  userId        String?
  user          User? @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  // Anonymous submissions
  email         String?
  name          String?
  phone         String?
  
  // Status
  status        EventFormSubmissionStatus @default(PENDING)
  approvedBy    String?
  approvedAt    DateTime?
  rejectedReason String?
  
  responses     EventFormResponse[]
  
  // Registration connection
  registrationId String? @unique
  registration   EventRegistration? @relation(fields: [registrationId], references: [id])
  
  submittedAt   DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([formId])
  @@index([userId])
  @@map("event_form_submissions")
}

model EventFormResponse {
  id           String @id @default(cuid())
  submissionId String
  submission   EventFormSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  fieldId      String
  field        EventFormField @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  
  // Response value (stored as JSON to handle any type)
  value        Json
  
  createdAt    DateTime @default(now())
  
  @@unique([submissionId, fieldId])
  @@map("event_form_responses")
}

// Event waiting list model
model EventWaitingList {
  id           String @id @default(cuid())
  eventId      String
  event        Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId       String
  user         User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  position     Int // position in waiting list
  priority     Int @default(0) // higher number = higher priority
  
  // Notification preferences
  notifyEmail  Boolean @default(true)
  notifySms    Boolean @default(false)
  
  // Status
  isActive     Boolean @default(true)
  promotedAt   DateTime? // when promoted from waiting list
  
  joinedAt     DateTime @default(now())
  
  @@unique([eventId, userId])
  @@index([eventId, position])
  @@map("event_waiting_list")
}

// Communication templates
model EventNotificationTemplate {
  id          String @id @default(cuid())
  eventId     String
  event       Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  type        EventNotificationType
  name        String
  
  // Email template
  subject     String?
  htmlContent String? @db.Text
  textContent String? @db.Text
  
  // SMS template
  smsContent  String?
  
  // In-app notification
  title       String?
  message     String? @db.Text
  
  // Timing
  isActive    Boolean @default(true)
  sendAt      EventNotificationTiming
  hoursOffset Int? // hours before/after event
  
  sentLogs    EventNotificationLog[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("event_notification_templates")
}

model EventNotificationLog {
  id         String @id @default(cuid())
  templateId String
  template   EventNotificationTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  userId     String
  user       User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type       String // email, sms, push, inapp
  status     String // sent, failed, delivered, read
  
  error      String?
  metadata   Json? // tracking info, message ids, etc.
  
  sentAt     DateTime @default(now())
  
  @@map("event_notification_logs")
}

// Enums for form system
enum EventFormFieldType {
  TEXT
  EMAIL
  PHONE
  NUMBER
  DATE
  DATETIME
  TIME
  SELECT
  RADIO
  CHECKBOX
  MULTISELECT
  TEXTAREA
  FILE
  BOOLEAN
  CPF
  RG
  CEP
}

enum EventFormSubmissionStatus {
  PENDING
  APPROVED
  REJECTED
  INCOMPLETE
}

enum EventNotificationType {
  REGISTRATION_CONFIRMATION
  REGISTRATION_APPROVED
  REGISTRATION_REJECTED
  EVENT_REMINDER
  EVENT_UPDATE
  EVENT_CANCELLED
  WAITING_LIST_PROMOTION
  CUSTOM
}

enum EventNotificationTiming {
  IMMEDIATE
  HOURS_BEFORE
  DAYS_BEFORE
  WEEKS_BEFORE
  AT_EVENT_TIME
  HOURS_AFTER
  DAYS_AFTER
}
