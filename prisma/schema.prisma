// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  ADMIN
  PRIEST
  ORGANIZER
  MEMBER
  VISITOR
}

enum EventStatus {
  DRAFT
  PUBLISHED
  CANCELLED
  COMPLETED
}

enum ParticipantLevel {
  NOVICE    // Novato
  SERVANT   // Servo
  LEADER    // Líder
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

// User and Authentication
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  role      UserRole @default(VISITOR)
  
  // Profile
  profile   UserProfile?
  
  // Relations
  parishes  ParishPriest[]
  events    Event[]
  registrations EventRegistration[]
  appointments  Appointment[]
  ministryMembers MinistryMember[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("users")
}

model UserProfile {
  id          String  @id @default(cuid())
  userId      String  @unique
  user        User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  firstName   String
  lastName    String
  phone       String?
  avatar      String?
  bio         String? @db.Text
  
  // Location
  stateId     String?
  state       State?  @relation(fields: [stateId], references: [id])
  cityId      String?
  city        City?   @relation(fields: [cityId], references: [id])
  
  // Participant data
  level       ParticipantLevel @default(NOVICE)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("user_profiles")
}

// Location Models
model State {
  id          String @id @default(cuid())
  name        String
  code        String @unique // SP, RJ, etc.
  
  cities      City[]
  parishes    Parish[]
  profiles    UserProfile[]
  
  @@map("states")
}

model City {
  id          String @id @default(cuid())
  name        String
  stateId     String
  state       State  @relation(fields: [stateId], references: [id])
  
  parishes    Parish[]
  profiles    UserProfile[]
  events      Event[]
  
  @@map("cities")
}

// Parish Models
model Diocese {
  id        String   @id @default(cuid())
  name      String
  
  parishes  Parish[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("dioceses")
}

model Parish {
  id          String @id @default(cuid())
  name        String
  address     String
  description String? @db.Text
  phone       String?
  email       String?
  website     String?
  
  // Location
  stateId     String
  state       State  @relation(fields: [stateId], references: [id])
  cityId      String
  city        City   @relation(fields: [cityId], references: [id])
  
  // Diocese
  dioceseId   String
  diocese     Diocese @relation(fields: [dioceseId], references: [id])
  
  // Relations
  priests     ParishPriest[]
  contacts    ParishContact[]
  masses      Mass[]
  events      Event[]
  ministries  Ministry[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("parishes")
}

model ParishPriest {
  id        String  @id @default(cuid())
  parishId  String
  parish    Parish  @relation(fields: [parishId], references: [id], onDelete: Cascade)
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  isMain    Boolean @default(false) // Pároco principal
  
  createdAt DateTime @default(now())
  
  @@unique([parishId, userId])
  @@map("parish_priests")
}

model ParishContact {
  id        String @id @default(cuid())
  parishId  String
  parish    Parish @relation(fields: [parishId], references: [id], onDelete: Cascade)
  
  type      String // facebook, instagram, whatsapp, etc.
  value     String
  
  @@map("parish_contacts")
}

model Mass {
  id          String @id @default(cuid())
  parishId    String
  parish      Parish @relation(fields: [parishId], references: [id], onDelete: Cascade)
  
  dayOfWeek   Int    // 0 = Sunday, 1 = Monday, etc.
  time        String // "08:00", "19:30", etc.
  type        String @default("normal") // normal, children, wedding, etc.
  language    String @default("pt") // pt, en, es, etc.
  description String?
  
  isActive    Boolean @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("masses")
}

// Event Models
model Event {
  id            String      @id @default(cuid())
  title         String
  description   String      @db.Text
  content       String?     @db.LongText
  
  startDate     DateTime
  endDate       DateTime?
  location      String
  maxParticipants Int?
  price         Decimal?    @db.Decimal(10,2)
  
  status        EventStatus @default(DRAFT)
  
  // Relations
  organizerId   String
  organizer     User        @relation(fields: [organizerId], references: [id])
  parishId      String?
  parish        Parish?     @relation(fields: [parishId], references: [id])
  cityId        String?
  city          City?       @relation(fields: [cityId], references: [id])
  
  registrations EventRegistration[]
  products      EventProduct[]
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  @@map("events")
}

model EventRegistration {
  id          String @id @default(cuid())
  eventId     String
  event       Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId      String
  user        User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  status      String @default("confirmed") // confirmed, waiting, cancelled
  data        Json?  // Additional form data
  
  createdAt   DateTime @default(now())
  
  @@unique([eventId, userId])
  @@map("event_registrations")
}

// Mini Bar Models
model EventProduct {
  id          String @id @default(cuid())
  eventId     String
  event       Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  name        String
  description String?
  price       Decimal @db.Decimal(10,2)
  stock       Int     @default(0)
  category    String
  image       String?
  
  orders      ProductOrder[]
  
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("event_products")
}

model ProductOrder {
  id          String       @id @default(cuid())
  productId   String
  product     EventProduct @relation(fields: [productId], references: [id])
  userId      String
  
  quantity    Int
  unitPrice   Decimal      @db.Decimal(10,2)
  totalPrice  Decimal      @db.Decimal(10,2)
  
  createdAt   DateTime     @default(now())
  
  @@map("product_orders")
}

// Ministry Models
model Ministry {
  id          String @id @default(cuid())
  name        String
  description String? @db.Text
  
  parishId    String
  parish      Parish @relation(fields: [parishId], references: [id], onDelete: Cascade)
  
  members     MinistryMember[]
  schedules   MinistrySchedule[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("ministries")
}

model MinistryMember {
  id          String   @id @default(cuid())
  ministryId  String
  ministry    Ministry @relation(fields: [ministryId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  role        String   @default("member") // leader, assistant, member
  isActive    Boolean  @default(true)
  
  schedules   MinistrySchedule[]
  
  joinedAt    DateTime @default(now())
  
  @@unique([ministryId, userId])
  @@map("ministry_members")
}

model MinistrySchedule {
  id          String         @id @default(cuid())
  ministryId  String
  ministry    Ministry       @relation(fields: [ministryId], references: [id], onDelete: Cascade)
  memberId    String
  member      MinistryMember @relation(fields: [memberId], references: [id], onDelete: Cascade)
  
  date        DateTime
  time        String
  description String?
  type        String // mass, event, meeting, etc.
  
  confirmed   Boolean @default(false)
  
  createdAt   DateTime @default(now())
  
  @@map("ministry_schedules")
}

// Appointment Models
model Appointment {
  id          String            @id @default(cuid())
  userId      String
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type        String            // confession, counseling, meeting
  date        DateTime
  time        String
  duration    Int               @default(30) // minutes
  
  description String?           @db.Text
  notes       String?           @db.Text
  
  status      AppointmentStatus @default(PENDING)
  
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  
  @@map("appointments")
}
