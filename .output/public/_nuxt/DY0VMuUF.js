var R=Object.defineProperty;var T=(t,n,s)=>n in t?R(t,n,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[n]=s;var A=(t,n,s)=>T(t,typeof n!="symbol"?n+"":n,s);import{R as V,D as B,a1 as G,a2 as H,a3 as j,h as q,s as z,K as L,L as Q,J as x,j as X,o as Z,w as ee,N as te,m as ae,E as re,l as U,W as ne}from"./wPnuorX7.js";import{u as se}from"./CQ8b8sfu.js";import{t as W,h as $,j as ie,k as oe,l as le}from"./BtdOvfXc.js";function ue(t){return t.validate&&t.__isYupSchema__}function ce(t){return t.inner!==void 0}function de(t){return"schema"in t&&typeof t.coercer=="function"&&typeof t.validator=="function"&&typeof t.refiner=="function"}function fe(t){return t.validateAsync!==void 0&&t.id!==void 0}function me(t){return t.isJoi===!0}function pe(t){return"~standard"in t}async function ye(t,n){var a;const s=await n["~standard"].validate(t);return s.issues?{errors:((a=s.issues)==null?void 0:a.map(o=>{var u;return{name:((u=o.path)==null?void 0:u.map(m=>typeof m=="object"?m.key:m).join("."))||"",message:o.message}}))||[],result:null}:{errors:null,result:s.value}}async function ve(t,n){try{return{errors:null,result:await n.validate(t,{abortEarly:!1})}}catch(s){if(ce(s))return{errors:s.inner.map(o=>({name:o.path??"",message:o.message})),result:null};throw s}}async function he(t,n){const[s,a]=n.validate(t);return s?{errors:s.failures().map(u=>({message:u.message,name:u.path.join(".")})),result:null}:{errors:null,result:a}}async function we(t,n){try{return{errors:null,result:await n.validateAsync(t,{abortEarly:!1})}}catch(s){if(me(s))return{errors:s.details.map(o=>({name:o.path.join("."),message:o.message})),result:null};throw s}}function be(t,n){if(pe(n))return ye(t,n);if(fe(n))return we(t,n);if(ue(n))return ve(t,n);if(de(n))return he(t,n);throw new Error("Form validation failed: Unsupported form schema")}class F extends Error{constructor(s,a,o){super("Form validation exception");A(this,"formId");A(this,"errors");A(this,"children");this.formId=s,this.errors=a,this.children=o,Object.setPrototypeOf(this,F.prototype)}}const Se={base:""},qe={__name:"Form",props:{id:{type:[String,Number],required:!1},schema:{type:null,required:!1},state:{type:Object,required:!0},validate:{type:Function,required:!1},validateOn:{type:Array,required:!1,default(){return["input","blur","change"]}},disabled:{type:Boolean,required:!1},validateOnInputDelay:{type:Number,required:!1,default:300},transform:{type:Boolean,required:!1,default:!0},attach:{type:Boolean,required:!1,default:!0},loadingAuto:{type:Boolean,required:!1,default:!0},class:{type:null,required:!1},onSubmit:{type:Function,required:!1}},emits:["submit","error"],setup(t,{expose:n,emit:s}){const a=t,o=s,u=V(),m=B(()=>{var e;return W({extend:W(Se),...((e=u.ui)==null?void 0:e.form)||{}})}),p=a.id??G(),k=se(`form-${p}`),y=a.attach&&H($,void 0);j($,k);const C=q(new Map);z(async()=>{k.on(async e=>{var r;e.type==="attach"?C.value.set(e.formId,{validate:e.validate}):e.type==="detach"?C.value.delete(e.formId):(r=a.validateOn)!=null&&r.includes(e.type)&&!f.value&&(e.type!=="input"?await v({name:e.name,silent:!0,nested:!1}):(e.eager||D.has(e.name))&&await v({name:e.name,silent:!0,nested:!1})),e.type==="blur"&&D.add(e.name),(e.type==="change"||e.type==="input"||e.type==="blur"||e.type==="focus")&&K.add(e.name),(e.type==="change"||e.type==="input")&&O.add(e.name)})}),L(()=>{k.reset()}),z(async()=>{y&&(await Q(),y.emit({type:"attach",validate:v,formId:p}))}),L(()=>{y&&y.emit({type:"detach",formId:p})});const i=q([]);j("form-errors",i);const _=q({});j(le,_);const O=new Set,K=new Set,D=new Set;function J(e){return e.map(r=>{var l;return{...r,id:r!=null&&r.name?(l=_.value[r.name])==null?void 0:l.id:void 0}})}const Y=q(null);async function M(){let e=a.validate?await a.validate(a.state)??[]:[];if(a.schema){const{errors:r,result:l}=await be(a.state,a.schema);r?e=e.concat(r):Y.value=l}return J(e)}async function v(e={silent:!1,nested:!0,transform:!1}){const r=e.name&&!Array.isArray(e.name)?[e.name]:e.name,l=!r&&e.nested?Array.from(C.value.values()).map(({validate:d})=>d(e).then(()=>{}).catch(h=>{if(!(h instanceof F))throw h;return h})):[];if(r){const d=i.value.filter(w=>!r.some(b=>{var g,E,I;const S=(E=(g=_.value)==null?void 0:g[b])==null?void 0:E.pattern;return b===w.name||S&&((I=w.name)==null?void 0:I.match(S))})),h=(await M()).filter(w=>r.some(b=>{var g,E,I;const S=(E=(g=_.value)==null?void 0:g[b])==null?void 0:E.pattern;return b===w.name||S&&((I=w.name)==null?void 0:I.match(S))}));i.value=d.concat(h)}else i.value=await M();const c=(await Promise.all(l)).filter(d=>d!==void 0);if(i.value.length+c.length>0){if(e.silent)return!1;throw new F(p,i.value,c)}return e.transform&&Object.assign(a.state,Y.value),a.state}const f=q(!1);j(ie,x(f));async function N(e){var l;f.value=a.loadingAuto&&!0;const r=e;try{r.data=await v({nested:!0,transform:a.transform}),await((l=a.onSubmit)==null?void 0:l.call(a,r)),O.clear()}catch(c){if(!(c instanceof F))throw c;const d={...r,errors:c.errors,children:c.children};o("error",d)}finally{f.value=!1}}const P=B(()=>a.disabled||f.value);return j(oe,B(()=>({disabled:P.value,validateOnInputDelay:a.validateOnInputDelay}))),n({validate:v,errors:i,setErrors(e,r){r?i.value=i.value.filter(l=>l.name!==r).concat(J(e)):i.value=J(e)},async submit(){await N(new Event("submit"))},getErrors(e){return e?i.value.filter(r=>r.name===e):i.value},clear(e){e?i.value=i.value.filter(r=>r.name!==e):i.value=[]},disabled:P,loading:f,dirty:B(()=>!!O.size),dirtyFields:x(O),blurredFields:x(D),touchedFields:x(K)}),(e,r)=>(Z(),X(ne(U(y)?"div":"form"),{id:U(p),class:re(m.value({class:a.class})),onSubmit:ae(N,["prevent"])},{default:ee(()=>[te(e.$slots,"default",{errors:i.value})]),_:3},40,["id","class"]))}};export{qe as _};
