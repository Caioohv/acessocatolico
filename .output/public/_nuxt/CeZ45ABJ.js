var V=Object.defineProperty;var W=(t,n,s)=>n in t?V(t,n,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[n]=s;var B=(t,n,s)=>W(t,typeof n!="symbol"?n+"":n,s);import{z as G,f as O,A as H,ad as Q,ag as j,F as q,g as N,h as U,n as R,ac as x,j as X,o as Z,w as ee,r as te,q as ae,B as re,k as $,s as ne}from"./CuMR5YMQ.js";import{u as se}from"./BR4tawBe.js";import{t as L,k as T,m as ie,n as oe,o as le}from"./B2Dk-QT9.js";function ue(t){return t.validate&&t.__isYupSchema__}function ce(t){return t.inner!==void 0}function de(t){return"schema"in t&&typeof t.coercer=="function"&&typeof t.validator=="function"&&typeof t.refiner=="function"}function fe(t){return t.validateAsync!==void 0&&t.id!==void 0}function me(t){return t.isJoi===!0}function pe(t){return"~standard"in t}async function ye(t,n){var a;const s=await n["~standard"].validate(t);return s.issues?{errors:((a=s.issues)==null?void 0:a.map(o=>{var u;return{name:((u=o.path)==null?void 0:u.map(m=>typeof m=="object"?m.key:m).join("."))||"",message:o.message}}))||[],result:null}:{errors:null,result:s.value}}async function ve(t,n){try{return{errors:null,result:await n.validate(t,{abortEarly:!1})}}catch(s){if(ce(s))return{errors:s.inner.map(o=>({name:o.path??"",message:o.message})),result:null};throw s}}async function he(t,n){const[s,a]=n.validate(t);return s?{errors:s.failures().map(u=>({message:u.message,name:u.path.join(".")})),result:null}:{errors:null,result:a}}async function we(t,n){try{return{errors:null,result:await n.validateAsync(t,{abortEarly:!1})}}catch(s){if(me(s))return{errors:s.details.map(o=>({name:o.path.join("."),message:o.message})),result:null};throw s}}function be(t,n){if(pe(n))return ye(t,n);if(fe(n))return we(t,n);if(ue(n))return ve(t,n);if(de(n))return he(t,n);throw new Error("Form validation failed: Unsupported form schema")}class F extends Error{constructor(s,a,o){super("Form validation exception");B(this,"formId");B(this,"errors");B(this,"children");this.formId=s,this.errors=a,this.children=o,Object.setPrototypeOf(this,F.prototype)}}const ge={base:""},qe={__name:"Form",props:{id:{type:[String,Number],required:!1},schema:{type:null,required:!1},state:{type:Object,required:!0},validate:{type:Function,required:!1},validateOn:{type:Array,required:!1,default(){return["input","blur","change"]}},disabled:{type:Boolean,required:!1},validateOnInputDelay:{type:Number,required:!1,default:300},transform:{type:Boolean,required:!1,default:!0},attach:{type:Boolean,required:!1,default:!0},loadingAuto:{type:Boolean,required:!1,default:!0},class:{type:null,required:!1},onSubmit:{type:Function,required:!1}},emits:["submit","error"],setup(t,{expose:n,emit:s}){const a=t,o=s,u=G(),m=O(()=>{var e;return L({extend:L(ge),...((e=u.ui)==null?void 0:e.form)||{}})}),p=a.id??H(),k=se(`form-${p}`),y=a.attach&&Q(T,void 0);j(T,k);const C=q(new Map);N(async()=>{k.on(async e=>{var r;e.type==="attach"?C.value.set(e.formId,{validate:e.validate}):e.type==="detach"?C.value.delete(e.formId):(r=a.validateOn)!=null&&r.includes(e.type)&&!f.value&&(e.type!=="input"?await v({name:e.name,silent:!0,nested:!1}):(e.eager||D.has(e.name))&&await v({name:e.name,silent:!0,nested:!1})),e.type==="blur"&&D.add(e.name),(e.type==="change"||e.type==="input"||e.type==="blur"||e.type==="focus")&&K.add(e.name),(e.type==="change"||e.type==="input")&&A.add(e.name)})}),U(()=>{k.reset()}),N(async()=>{y&&(await R(),y.emit({type:"attach",validate:v,formId:p}))}),U(()=>{y&&y.emit({type:"detach",formId:p})});const i=q([]);j("form-errors",i);const _=q({});j(le,_);const A=new Set,K=new Set,D=new Set;function J(e){return e.map(r=>{var l;return{...r,id:r!=null&&r.name?(l=_.value[r.name])==null?void 0:l.id:void 0}})}const Y=q(null);async function z(){let e=a.validate?await a.validate(a.state)??[]:[];if(a.schema){const{errors:r,result:l}=await be(a.state,a.schema);r?e=e.concat(r):Y.value=l}return J(e)}async function v(e={silent:!1,nested:!0,transform:!1}){const r=e.name&&!Array.isArray(e.name)?[e.name]:e.name,l=!r&&e.nested?Array.from(C.value.values()).map(({validate:d})=>d(e).then(()=>{}).catch(h=>{if(!(h instanceof F))throw h;return h})):[];if(r){const d=i.value.filter(w=>!r.some(b=>{var S,E,I;const g=(E=(S=_.value)==null?void 0:S[b])==null?void 0:E.pattern;return b===w.name||g&&((I=w.name)==null?void 0:I.match(g))})),h=(await z()).filter(w=>r.some(b=>{var S,E,I;const g=(E=(S=_.value)==null?void 0:S[b])==null?void 0:E.pattern;return b===w.name||g&&((I=w.name)==null?void 0:I.match(g))}));i.value=d.concat(h)}else i.value=await z();const c=(await Promise.all(l)).filter(d=>d!==void 0);if(i.value.length+c.length>0){if(e.silent)return!1;throw new F(p,i.value,c)}return e.transform&&Object.assign(a.state,Y.value),a.state}const f=q(!1);j(ie,x(f));async function M(e){var l;f.value=a.loadingAuto&&!0;const r=e;try{r.data=await v({nested:!0,transform:a.transform}),await((l=a.onSubmit)==null?void 0:l.call(a,r)),A.clear()}catch(c){if(!(c instanceof F))throw c;const d={...r,errors:c.errors,children:c.children};o("error",d)}finally{f.value=!1}}const P=O(()=>a.disabled||f.value);return j(oe,O(()=>({disabled:P.value,validateOnInputDelay:a.validateOnInputDelay}))),n({validate:v,errors:i,setErrors(e,r){r?i.value=i.value.filter(l=>l.name!==r).concat(J(e)):i.value=J(e)},async submit(){await M(new Event("submit"))},getErrors(e){return e?i.value.filter(r=>r.name===e):i.value},clear(e){e?i.value=i.value.filter(r=>r.name!==e):i.value=[]},disabled:P,loading:f,dirty:O(()=>!!A.size),dirtyFields:x(A),blurredFields:x(D),touchedFields:x(K)}),(e,r)=>(Z(),X(ne($(y)?"div":"form"),{id:$(p),class:re(m.value({class:a.class})),onSubmit:ae(M,["prevent"])},{default:ee(()=>[te(e.$slots,"default",{errors:i.value})]),_:3},40,["id","class"]))}};export{qe as _};
